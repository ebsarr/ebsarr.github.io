<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">

        
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">

        <link href="https://fonts.googleapis.com/css?family=Ubuntu|Ubuntu+Mono" rel="stylesheet"> 

        <title>Shell scripting tips</title>

        <link rel="stylesheet" href="/css/stylesheet.css">
    </head>
    <body>
      <div class="container-fluid">
        <nav class="navbar navbar-expand-md navbar-light">

          
          <span class="navbar-brand mb-0 h1"></span>

          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle Navigation" name="button">
            <span class="navbar-toggler-icon"></span>
          </button>

          <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
            <div class="navbar-nav">
              <a class="nav-item nav-link " href="/">Home</a>
              
              
              <a class="nav-item nav-link " href="/about/">About</a>
            </div>
          </div>
        </nav>

        <section id="page-title">
          <h1><a href="/">btaars.net</a></h1>
          <span id="author-name">
            <h6><a href="/about/"></a></h6>
          </span>
        </section>


<div class="blog-post">
  <h1>Shell scripting tips</h1>
  <div class="blog-post-subheader">
    <time>03 Mar 2019</time>
  </div>
  <div class="blog-post-content">
    

<p>It&rsquo;s been a while since the last time I wrote a shell script. A few years ago I had to automate many tasks for managing thousands of servers. This made me write many scripts for many purposes, like running a sanity check on a set of clusters, collecting and analysing logs or automating deployment of configurations across a set of hundreds of servers. I ended up with many tools at hand, and needed a way to productively write new tools, and also reuse the codes common to all the scripts etc &hellip;
<br>
In this post I will share the few practices that I applied when writing my scripts. I would not say it&rsquo;s best practice, it just did work for me. They are not all my creation, I took reference from some other people&rsquo;s scipts over the years, and some from shell scripting books.</p>

<h3 id="functions">Functions</h3>

<p>Using functions was my basic way of achieving code reuse. I designed my functions across all scripts to do one specific thing, and then composed all the scripts with just the logic to call the functions. Another advantage of doing this is that it made it easier to debug the scripts in case I run into an issue. As I was writing code for automating tasks on a large sclage infrastructure, scripts could tend to be very long, so using functions helped a lot for code clarity. When designing the scripts, the first thing that I prioritized was how to isolate code by using functions.
<br>
I followed a coding guideline for functions, with only three basic rules:</p>

<h4 id="function-names">Function names</h4>

<p>Always put the prefix &ldquo;func_&rdquo; followed by a name that describes what the function does. One example:</p>

<pre><code class="language-sh">func_panic () {
# Print error message to stderr and exit with error code
# @params:
#	${*}: error message
# @output:
#	stdout:	none
#	stderr:	error message
# @return: none. This function will exit the program with error code ${RC_ERROR}

	message=${*}
	printf &quot;%s\n&quot; &quot;${message}&quot; 1&gt;&amp;2
	exit ${RC_ERROR}
}
</code></pre>

<p>The reason to prefix all function names with <code>func_</code> is to differenciate them from other utilities or commands that you call from your script. If I named the function above just <code>panic</code>, you would see somewhere in the main script a function call like</p>

<pre><code>panic &quot;Exception occured&quot;
</code></pre>

<p>Well, one would think that <code>panic</code> is a command or a bash function like <code>echo</code> or <code>printf</code>. Prefixing the function names with <code>func_</code> help quickly differentiate my functions and other commands.</p>

<h4 id="function-documentation">Function documentation</h4>

<p>At the top of the function, include comments describing the function&rsquo;s purpose, expected input parameters, output and return codes. You may have notice in the previous example how the function was documented. Here is another example:</p>

<pre><code class="language-sh">func_delete_files () {
# Delete files one by one.
# Only files under ${BASE_DIR} will be deleted.
# Function will abort if it fails to delete one of the files.
# @params:
#	${*}: list of files(full path) to delete.
# @output:
#	stdout:	none
#	stderr:	error message
# @return:
#	${RC_SUCCESS}:	everything went file
#	${RC_ERROR}:	Failed to delete a file

	files=${*}
	for file in ${files}; do
		echo ${file} | grep ${BASE_DIR} &amp;&amp; rm ${file} || \
			echo &quot;Failed to delete or cannot delete files outside of ${BASE_DIR}&quot; 1&gt;&amp;2 &amp;&amp; return ${RC_ERROR}
	done
	return ${RC_SUCCESS}
}
</code></pre>

<p>Other people read your code. Even if you are the only one writing and maintaining the code, you will some day need to read the code. In my point of view, shell syntax is not very readable in the first place. So for at least isolated codes like functions, I think it is best practice to write some guidance about what the function does, what it expects as input parameter and so on. You&rsquo;ll thank yourself the day you come back and read a well documented function code that you wrote six month ago; at least I did&hellip;</p>

<h4 id="function-output-and-return-codes">Function output and return codes</h4>

<p>Since the <code>return</code> statement in shell scripts can only return codes, I made a habit of using <code>stdout</code> as a function return value as well. What I mean is I took advantage of the fact that you can pipe your function output as input to other programs. Everything that I printed to <code>stdout</code> inside a function should make sense to another program. Otherwise I did not print anything at all, or used <code>stderr</code> for sending information and warnings. Example:</p>

<pre><code class="language-sh">func_create_tmpfile () {
# Create and return a temp file
# @params: none
# @output:
#	stdout:	filename of temp file
#	stderr:	error message
# @return:
#	${RC_SUCCESS}:	everything went file
#	${RC_ERROR}:	Failure

	tmpfile=${TEMP_DIR}/${SELF}_`date +&quot;%s&quot;`.tmp
	touch ${tmpfile} || return ${RC_ERROR}
	printf &quot;%s&quot; &quot;${tmpfile}&quot; # This can be treated as a return value
	return ${RC_SUCCESS}
}

# We can call this function to create a temp file and get the filename
TMP_FILE=$( func_create_tmpfile ) 
</code></pre>

<p>You may have noticed that I always use the <code>return</code> statement in functions. Not having a <code>return</code> statement will not make your function fail or anything, but I also made it a habit to return error codes to specifically declare success or failure of the function execution. After a function call, the caller can do a simple check like with any other command:</p>

<pre><code class="language-sh">func_xxx # function call
if [ $? -ne ${RC_SUCCESS} ]; then
	# The function failed; do something
fi
</code></pre>

<h3 id="common-modules-and-file-structure">Common modules and file structure</h3>

<p>After writing a few scripts, I realized that there were common tasks that I had to rewrite. Since those scripts were written at different times, I ended up with different codes doing the same thing. In addition to this, log files and temporary files were handled differently in different scripts. I decided to group all the common stuffs in on script file, and reuse the file every time that I need to write a new script. Below are the things that I achieved doing this.</p>

<h4 id="standard-directory-and-file-structure">Standard directory and file structure</h4>

<p>I usually had to deal with three types of files with my scripts:</p>

<ul>
<li>Configuration files</li>
<li>Log files</li>
<li>Temporary files</li>
</ul>

<p>In addition to this, many of the scripts has to be deployed and executed on many servers. I decided to create a standard environment for all the scripts, and this meant to standardize how files and directories where structured. The standard deployement looked like this:</p>

<pre><code class="language-sh"># script install directory
BASE_DIR=&quot;&quot; # &lt;-- decide a location for all scripts

# Script file
SELF=${BASE_DIR}/`basename ${0}`

# directory to store all the scripts configuration files
CONFIG_DIR=${BASE_DIR}/config

# configuration file of script_name.sh
SELF=${BASE_DIR}/${CONFIG_DIR}/

# directory to store temporary files
TEMP_DIR=${BASE_DIR}/temp

# directory to store log files
LOG_DIR=${BASE_DIR}/logs/script_name.d

# log file for script_name.sh
LOG_FILE=${BASE_DIR}/${LOG_DIR}/script_name.log
</code></pre>

<p>Following this standard for all my scripts came with benefits:</p>

<ul>
<li>You don&rsquo;t need to rethink basic stuffs like where to store your configuration files or log files</li>
<li>You always know where your files are</li>
<li>Having a standard <code>${BASE_DIR}</code> can help isolate your scripts environment from other system files, thus helps you enforce rules such as &ldquo;never delete a file outside of <code>${BASE_DIR}</code>&rdquo;. Especially when working on business critical systems, deleting a file by mistake, or due to a bug in your script is very dangerous. This rule helped me avoid those types of accidents.</li>
</ul>

<h4 id="common-module">Common module</h4>

  </div>
</div>

      <footer>
        <hr>
        <small>
          &copy; 2022 .
          Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> using the <a href="https://github.com/arjunkrishnababu96/basics" target="_blank">Basics</a> theme.
        </small>
      </footer>
    </div> 

    
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>
  </body>
</html>

